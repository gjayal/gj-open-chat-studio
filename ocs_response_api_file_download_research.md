# OpenAI Response API File Download Issue Research

## Problem Summary
The ESPEN project team is experiencing an issue where their Data Assistant, migrated from the Assistants API to the Response API, is not generating downloadable links for CSV files and graphs despite having the Code Execution tool enabled. This functionality works correctly in the Assistants platform but fails in the Response API implementation.

## Key Findings

### 1. Response API vs Assistants API Differences

**Response API Characteristics:**
- Newer API designed to replace the Assistants API
- Built-in tools include web search, file search, and code execution
- Server-side conversation state management
- Different file handling mechanisms compared to Assistants API

**File Handling Differences:**
- Response API uses a **container-based approach** for code execution
- Files generated by code execution are stored in containers, not directly accessible
- Different annotation system for file citations
- Files must be retrieved using specific container endpoints

### 2. File Download Mechanism in Response API

Based on the research, the Response API handles file downloads differently:

**Container-Based File Storage:**
- Code execution runs in containers with unique container IDs
- Generated files are stored within these containers
- Files have container-specific file IDs
- Containers expire after ~20 minutes of inactivity

**Annotation System:**
- Response API uses `container_file_citation` annotations
- Annotations include:
  - `container_id`: The container where the file is stored
  - `file_id`: The specific file identifier
  - `filename`: The original filename

### 3. Required Implementation Steps

To retrieve files from Response API code execution:

1. **Enable Code Execution Output Tracking:**
   ```python
   response = client.responses.create(
       model="gpt-4o",
       input=user_input,
       tools=[{"type": "code_interpreter"}],
       include=["code_interpreter_call.outputs"]  # Important!
   )
   ```

2. **Extract Container and File Information:**
   ```python
   # Look for annotations in the response
   for message in response.output:
       if hasattr(message, 'content'):
           for content in message.content:
               if hasattr(content, 'annotations'):
                   for annotation in content.annotations:
                       if annotation.type == "container_file_citation":
                           container_id = annotation.container_id
                           file_id = annotation.file_id
                           filename = annotation.filename
   ```

3. **Retrieve Files Using Container API:**
   ```python
   # Use the container API endpoints
   file_content = client.containers.files.retrieve(
       container_id=container_id,
       file_id=file_id
   )
   ```

### 4. Specific API Endpoints for File Retrieval

The Response API provides these endpoints for file management:
- `GET /containers/{container_id}/files` - List files in container
- `GET /containers/{container_id}/files/{file_id}` - Retrieve specific file
- `DELETE /containers/{container_id}` - Delete container

### 5. Code Example for File Download Implementation

```python
import openai
import os

def handle_response_with_file_download(client, user_input):
    response = client.responses.create(
        model="gpt-4o",
        input=user_input,
        tools=[{"type": "code_interpreter"}],
        include=["code_interpreter_call.outputs"]
    )
    
    # Extract file information from annotations
    downloadable_files = []
    
    for message in response.output:
        if hasattr(message, 'content'):
            for content in message.content:
                if hasattr(content, 'annotations'):
                    for annotation in content.annotations:
                        if annotation.type == "container_file_citation":
                            file_info = {
                                'container_id': annotation.container_id,
                                'file_id': annotation.file_id,
                                'filename': annotation.filename
                            }
                            downloadable_files.append(file_info)
    
    # Download files
    for file_info in downloadable_files:
        try:
            file_content = client.containers.files.retrieve(
                container_id=file_info['container_id'],
                file_id=file_info['file_id']
            )
            
            # Save file or provide download link
            with open(file_info['filename'], 'wb') as f:
                f.write(file_content)
                
        except Exception as e:
            print(f"Error retrieving file {file_info['filename']}: {e}")
    
    return response, downloadable_files
```

## Recommendations

### 1. Immediate Actions
- Implement container-based file retrieval in the Response API integration
- Add the `include=["code_interpreter_call.outputs"]` parameter to API calls
- Parse annotations to extract container and file information
- Use the container API endpoints to retrieve generated files

### 2. Configuration Changes
- Update the Response API implementation to handle container file citations
- Implement proper error handling for container expiration
- Add file download functionality that works with the container system

### 3. Alternative Solutions
- Consider using the `code_interpreter` tool with explicit container management
- Implement a file caching system to store retrieved files
- Add user notifications when files are ready for download

### 4. Code Structure Improvements
```python
# Create container explicitly for better control
container = client.containers.create(name="data-assistant-container")

response = client.responses.create(
    model="gpt-4o",
    input=user_input,
    tools=[{
        "type": "code_interpreter",
        "container": container.id
    }],
    tool_choice="required"
)
```

## Additional Considerations

### Security and Limitations
- Containers have limited lifespan (~20 minutes)
- Files must be retrieved promptly after generation
- No network access in containers by default
- Limited to pre-installed packages

### Performance Implications
- File retrieval adds additional API calls
- Container cleanup should be implemented
- Consider implementing file caching strategies

## Next Steps

1. **Implement container file retrieval** in the current Response API integration
2. **Test with sample CSV and graph generation** to verify functionality
3. **Add proper error handling** for container expiration and file retrieval failures
4. **Document the new file download workflow** for the team
5. **Consider migrating back to Assistants API** if file download is critical and the Response API implementation proves too complex

## References

- OpenAI Response API Documentation
- Container Files API Reference: https://platform.openai.com/docs/api-reference/container-files
- Community discussions on Response API file handling
- OpenAI Cookbook examples for Response API with code execution